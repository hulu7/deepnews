define(function(a){jQuery=a("jquery"),function(a,b){function d(a,b,c){var f,h,i,d=a.children(),e=!1;for(a.empty(),f=0,h=d.length;h>f;f++){if(i=d.eq(f),a.append(i),c&&a.append(c),g(a,b)){i.remove(),e=!0;break}c&&c.detach()}return e}function e(b,c,d,h,i){var j=!1,k="a, table, thead, tbody, tfoot, tr, col, colgroup, object, embed, param, ol, ul, dl, blockquote, select, optgroup, option, textarea, script, style",l="script, .dotdotdot-keep";return b.contents().detach().each(function(){var m=this,n=a(m);if("undefined"==typeof m)return!0;if(n.is(l))b.append(n);else{if(j)return!0;b.append(n),!i||n.is(h.after)||n.find(h.after).length||b[b.is(k)?"after":"append"](i),g(d,h)&&(j=3==m.nodeType?f(n,c,d,h,i):e(n,c,d,h,i)),j||i&&i.detach()}}),c.addClass("is-truncated"),j}function f(b,c,d,e,f){var l,n,o,p,q,r,s,t,u,v,w,i=b[0];if(!i)return!1;for(l=k(i),n=-1!==l.indexOf(" ")?" ":"　",o="letter"==e.wrap?"":n,p=l.split(o),q=-1,r=-1,s=0,t=p.length-1,e.fallbackToLetter&&0==s&&0==t&&(o="",p=l.split(o),t=p.length-1);t>=s&&(0!=s||0!=t)&&(u=Math.floor((s+t)/2),u!=r);)r=u,j(i,p.slice(0,r+1).join(o)+e.ellipsis),d.children().each(function(){a(this).toggle().toggle()}),g(d,e)?(t=r,e.fallbackToLetter&&0==s&&0==t&&(o="",p=p[0].split(o),q=-1,r=-1,s=0,t=p.length-1)):(q=r,s=r);return-1==q||1==p.length&&0==p[0].length?(v=b.parent(),b.detach(),w=f&&f.closest(v).length?f.length:0,v.contents().length>w?i=m(v.contents().eq(-1-w),c):(i=m(v,c,!0),w||v.detach()),i&&(l=h(k(i),e),j(i,l),w&&f&&a(i).parent().append(f))):(l=h(p.slice(0,q+1).join(o),e),j(i,l)),!0}function g(a,b){return a.innerHeight()>b.maxHeight}function h(b,c){for(;a.inArray(b.slice(-1),c.lastCharacter.remove)>-1;)b=b.slice(0,-1);return a.inArray(b.slice(-1),c.lastCharacter.noEllipsis)<0&&(b+=c.ellipsis),b}function i(a){return{width:a.innerWidth(),height:a.innerHeight()}}function j(a,b){a.innerText?a.innerText=b:a.nodeValue?a.nodeValue=b:a.textContent&&(a.textContent=b)}function k(a){return a.innerText?a.innerText:a.nodeValue?a.nodeValue:a.textContent?a.textContent:""}function l(a){do a=a.previousSibling;while(a&&1!==a.nodeType&&3!==a.nodeType);return a}function m(b,c,d){var f,e=b&&b[0];if(e){if(!d){if(3===e.nodeType)return e;if(a.trim(b.text()))return m(b.contents().last(),c)}for(f=l(e);!f;){if(b=b.parent(),b.is(c)||!b.length)return!1;f=l(b[0])}if(f)return m(a(f),c)}return!1}function n(b,c){return b?"string"==typeof b?(b=a(b,c),b.length?b:!1):b.jquery?b:!1:!1}function o(a){var d,e,f,b=a.innerHeight(),c=["paddingTop","paddingBottom"];for(d=0,e=c.length;e>d;d++)f=parseInt(a.css(c[d]),10),isNaN(f)&&(f=0),b-=f;return b}var c,p,q;a.fn.dotdotdot||(a.fn.dotdotdot=function(b){var f,h,j,k,l,m,p;return 0==this.length?(a.fn.dotdotdot.debug('No element found for "'+this.selector+'".'),this):this.length>1?this.each(function(){a(this).dotdotdot(b)}):(f=this,h=f.contents(),f.data("dotdotdot")&&f.trigger("destroy.dot"),f.data("dotdotdot-style",f.attr("style")||""),f.css("word-wrap","break-word"),"nowrap"===f.css("white-space")&&f.css("white-space","normal"),f.bind_events=function(){return f.bind("update.dot",function(b,c){switch(f.removeClass("is-truncated"),b.preventDefault(),b.stopPropagation(),typeof j.height){case"number":j.maxHeight=j.height;break;case"function":j.maxHeight=j.height.call(f[0]);break;default:j.maxHeight=o(f)}j.maxHeight+=j.tolerance,"undefined"!=typeof c&&(("string"==typeof c||"nodeType"in c&&1===c.nodeType)&&(c=a("<div />").append(c).contents()),c instanceof a&&(h=c)),p=f.wrapInner('<div class="dotdotdot" />').children(),p.contents().detach().end().append(h.clone(!0)).find("br").replaceWith("  <br />  ").end().css({height:"auto",width:"auto",border:"none",padding:0,margin:0});var i=!1,l=!1;return k.afterElement&&(i=k.afterElement.clone(!0),i.show(),k.afterElement.detach()),g(p,j)&&(l="children"==j.wrap?d(p,j,i):e(p,f,p,j,i)),p.replaceWith(p.contents()),p=null,a.isFunction(j.callback)&&j.callback.call(f[0],l,h),k.isTruncated=l,l}).bind("isTruncated.dot",function(a,b){return a.preventDefault(),a.stopPropagation(),"function"==typeof b&&b.call(f[0],k.isTruncated),k.isTruncated}).bind("originalContent.dot",function(a,b){return a.preventDefault(),a.stopPropagation(),"function"==typeof b&&b.call(f[0],h),h}).bind("destroy.dot",function(a){a.preventDefault(),a.stopPropagation(),f.unwatch().unbind_events().contents().detach().end().append(h).attr("style",f.data("dotdotdot-style")||"").data("dotdotdot",!1)}),f},f.unbind_events=function(){return f.unbind(".dot"),f},f.watch=function(){if(f.unwatch(),"window"==j.watch){var b=a(window),c=b.width(),d=b.height();b.bind("resize.dot"+k.dotId,function(){c==b.width()&&d==b.height()&&j.windowResizeFix||(c=b.width(),d=b.height(),m&&clearInterval(m),m=setTimeout(function(){f.trigger("update.dot")},100))})}else l=i(f),m=setInterval(function(){if(f.is(":visible")){var a=i(f);(l.width!=a.width||l.height!=a.height)&&(f.trigger("update.dot"),l=a)}},500);return f},f.unwatch=function(){return a(window).unbind("resize.dot"+k.dotId),m&&clearInterval(m),f},j=a.extend(!0,{},a.fn.dotdotdot.defaults,b),k={},l={},m=null,p=null,j.lastCharacter.remove instanceof Array||(j.lastCharacter.remove=a.fn.dotdotdot.defaultArrays.lastCharacter.remove),j.lastCharacter.noEllipsis instanceof Array||(j.lastCharacter.noEllipsis=a.fn.dotdotdot.defaultArrays.lastCharacter.noEllipsis),k.afterElement=n(j.after,f),k.isTruncated=!1,k.dotId=c++,f.data("dotdotdot",!0).bind_events().trigger("update.dot"),j.watch&&f.watch(),f)},a.fn.dotdotdot.defaults={ellipsis:"... ",wrap:"word",fallbackToLetter:!0,lastCharacter:{},tolerance:0,callback:null,after:null,height:null,watch:!1,windowResizeFix:!0},a.fn.dotdotdot.defaultArrays={lastCharacter:{remove:[" ","　",",",";",".","!","?"],noEllipsis:[]}},a.fn.dotdotdot.debug=function(){},c=1,p=a.fn.html,a.fn.html=function(c){return c!=b&&!a.isFunction(c)&&this.data("dotdotdot")?this.trigger("update",[c]):p.apply(this,arguments)},q=a.fn.text,a.fn.text=function(c){return c!=b&&!a.isFunction(c)&&this.data("dotdotdot")?(c=a("<div />").text(c).html(),this.trigger("update",[c])):q.apply(this,arguments)})}(jQuery)});